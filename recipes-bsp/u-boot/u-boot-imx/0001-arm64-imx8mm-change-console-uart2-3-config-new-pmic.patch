From 21b1a90e177b882ee883c141959be1717e8c1ef1 Mon Sep 17 00:00:00 2001
From: Dominik Poggel <pog@iesy.com>
Date: Mon, 5 Dec 2022 11:49:05 +0100
Subject: [PATCH 1/3] arm64: imx8mm: change console uart2->3, config new pmic

---
 arch/arm/dts/imx8mm-evk-u-boot.dtsi     |   4 +-
 arch/arm/dts/imx8mm-evk.dts             | 133 +++++++++---------------
 board/freescale/imx8mm_evk/imx8mm_evk.c |   6 +-
 board/freescale/imx8mm_evk/spl.c        |  44 +++++---
 include/configs/imx8mm_evk.h            |   8 +-
 5 files changed, 88 insertions(+), 107 deletions(-)

diff --git a/arch/arm/dts/imx8mm-evk-u-boot.dtsi b/arch/arm/dts/imx8mm-evk-u-boot.dtsi
index 5bc030db9d..827dc9e06f 100644
--- a/arch/arm/dts/imx8mm-evk-u-boot.dtsi
+++ b/arch/arm/dts/imx8mm-evk-u-boot.dtsi
@@ -75,7 +75,7 @@
 	u-boot,dm-spl;
 };
 
-&pinctrl_uart2 {
+&pinctrl_uart3 {
 	u-boot,dm-spl;
 };
 
@@ -111,7 +111,7 @@
 	u-boot,dm-spl;
 };
 
-&uart2 {
+&uart3 {
 	u-boot,dm-spl;
 };
 
diff --git a/arch/arm/dts/imx8mm-evk.dts b/arch/arm/dts/imx8mm-evk.dts
index 09505c5ebd..aac02abb93 100644
--- a/arch/arm/dts/imx8mm-evk.dts
+++ b/arch/arm/dts/imx8mm-evk.dts
@@ -9,12 +9,12 @@
 #include "imx8mm.dtsi"
 
 / {
-	model = "NXP i.MX8MM EVK board";
+	model = "CM007u-boot_v0.1";
 	compatible = "fsl,imx8mm-evk", "fsl,imx8mm";
 
 	chosen {
-		bootargs = "console=ttymxc1,115200 earlycon=ec_imx6q,0x30890000,115200";
-		stdout-path = &uart2;
+		bootargs = "console=ttymxc2,115200 earlycon=ec_imx6q,0x30880000,115200";
+		stdout-path = &uart3;
 	};
 
 	leds {
@@ -100,7 +100,7 @@
 };
 
 &A53_0 {
-	cpu-supply = <&buck2_reg>;
+	cpu-supply = <&vdd_arm_0v9>;
 };
 
 &fec1 {
@@ -147,108 +147,77 @@
 	sda-gpios = <&gpio5 15 GPIO_ACTIVE_HIGH>;
 
 	pmic@4b {
-		compatible = "rohm,bd71847";
+		compatible = "nxp,pca9450a";
 		reg = <0x4b>;
 		pinctrl-0 = <&pinctrl_pmic>;
 		interrupt-parent = <&gpio1>;
 		interrupts = <3 GPIO_ACTIVE_LOW>;
-		rohm,reset-snvs-powered;
 
 		regulators {
-			buck1_reg: BUCK1 {
-				regulator-name = "BUCK1";
-				regulator-min-microvolt = <700000>;
-				regulator-max-microvolt = <1300000>;
-				regulator-boot-on;
-				regulator-always-on;
-				regulator-ramp-delay = <1250>;
+			vdd_soc_0v8: BUCK1 {
+				regulator-name = "0v8_soc";
+				regulator-min-microvolt = <850000>;
+				regulator-max-microvolt = <850000>;
 			};
 
-			buck2_reg: BUCK2 {
-				regulator-name = "BUCK2";
-				regulator-min-microvolt = <700000>;
-				regulator-max-microvolt = <1300000>;
-				regulator-boot-on;
-				regulator-always-on;
-				regulator-ramp-delay = <1250>;
-				rohm,dvs-run-voltage = <1000000>;
-				rohm,dvs-idle-voltage = <900000>;
+			vdd_arm_0v9: BUCK2 {
+				regulator-name = "0v9_arm";
+				regulator-min-microvolt = <850000>;
+				regulator-max-microvolt = <850000>;
 			};
 
-			buck3_reg: BUCK3 {
-				// BUCK5 in datasheet
-				regulator-name = "BUCK3";
-				regulator-min-microvolt = <700000>;
-				regulator-max-microvolt = <1350000>;
-				regulator-boot-on;
-				regulator-always-on;
+			vdd_dram_0v9: BUCK3 {
+				regulator-name = "0v9_dram";
+				regulator-min-microvolt = <850000>;
+				regulator-max-microvolt = <850000>;
 			};
 
-			buck4_reg: BUCK4 {
-				// BUCK6 in datasheet
-				regulator-name = "BUCK4";
-				regulator-min-microvolt = <3000000>;
+			nvcc_3v3: BUCK4 {
+				regulator-name = "3v3_io";
+				regulator-min-microvolt = <3300000>;
 				regulator-max-microvolt = <3300000>;
-				regulator-boot-on;
-				regulator-always-on;
 			};
 
-			buck5_reg: BUCK5 {
-				// BUCK7 in datasheet
-				regulator-name = "BUCK5";
-				regulator-min-microvolt = <1605000>;
-				regulator-max-microvolt = <1995000>;
-				regulator-boot-on;
-				regulator-always-on;
+			nvcc_1v8: BUCK5 {
+				regulator-name = "1v8_io";
+				regulator-min-microvolt = <1800000>;
+				regulator-max-microvolt = <1800000>;
 			};
 
-			buck6_reg: BUCK6 {
-				// BUCK8 in datasheet
-				regulator-name = "BUCK6";
-				regulator-min-microvolt = <800000>;
-				regulator-max-microvolt = <1400000>;
-				regulator-boot-on;
-				regulator-always-on;
+			nvcc_dram_1v1: BUCK6 {
+				regulator-name = "1v1_dram";
+				regulator-min-microvolt = <1100000>;
+				regulator-max-microvolt = <1100000>;
 			};
 
-			ldo1_reg: LDO1 {
-				regulator-name = "LDO1";
-				regulator-min-microvolt = <3000000>;
-				regulator-max-microvolt = <3300000>;
-				regulator-boot-on;
-				regulator-always-on;
+			nvcc_snvs_1v8: LDO1 {
+				regulator-name = "1v8_snvs";
+				regulator-min-microvolt = <1800000>;
+				regulator-max-microvolt = <1800000>;
 			};
 
-			ldo2_reg: LDO2 {
-				regulator-name = "LDO2";
-				regulator-min-microvolt = <900000>;
-				regulator-max-microvolt = <900000>;
-				regulator-boot-on;
-				regulator-always-on;
+			vdd_snvs_0v8: LDO2 {
+				regulator-name = "0v8_snvs";
+				regulator-min-microvolt = <800000>;
+				regulator-max-microvolt = <800000>;
 			};
 
-			ldo3_reg: LDO3 {
-				regulator-name = "LDO3";
+			vdda_1v8: LDO3 {
+				regulator-name = "1v8_vdda";
 				regulator-min-microvolt = <1800000>;
-				regulator-max-microvolt = <3300000>;
-				regulator-boot-on;
-				regulator-always-on;
+				regulator-max-microvolt = <1800000>;
 			};
 
-			ldo4_reg: LDO4 {
-				regulator-name = "LDO4";
+			vdd_mipi_0v9: LDO4 {
+				regulator-name = "0v9_mipi";
 				regulator-min-microvolt = <900000>;
-				regulator-max-microvolt = <1800000>;
-				regulator-boot-on;
-				regulator-always-on;
+				regulator-max-microvolt = <900000>;
 			};
 
-			ldo6_reg: LDO6 {
-				regulator-name = "LDO6";
-				regulator-min-microvolt = <900000>;
-				regulator-max-microvolt = <1800000>;
-				regulator-boot-on;
-				regulator-always-on;
+			vcc_sd: LDO5 {
+				regulator-name = "vcc_sd";
+				regulator-min-microvolt = <3300000>;
+				regulaotr-max-microvolt = <3300000>;
 			};
 		};
 	};
@@ -350,9 +319,9 @@
 	status = "okay";
 };
 
-&uart2 { /* console */
+&uart3 {
 	pinctrl-names = "default";
-	pinctrl-0 = <&pinctrl_uart2>;
+	pinctrl-0 = <&pinctrl_uart3>;
 	status = "okay";
 };
 
@@ -535,10 +504,10 @@
 		>;
 	};
 
-	pinctrl_uart2: uart2grp {
+	pinctrl_uart3: uart3grp {
 		fsl,pins = <
-			MX8MM_IOMUXC_UART2_RXD_UART2_DCE_RX	0x140
-			MX8MM_IOMUXC_UART2_TXD_UART2_DCE_TX	0x140
+			MX8MM_IOMUXC_UART3_RXD_UART3_DCE_RX 0x140
+			MX8MM_IOMUXC_UART3_TXD_UART3_DCE_TX 0x140
 		>;
 	};
 
diff --git a/board/freescale/imx8mm_evk/imx8mm_evk.c b/board/freescale/imx8mm_evk/imx8mm_evk.c
index af1599801d..188135c865 100644
--- a/board/freescale/imx8mm_evk/imx8mm_evk.c
+++ b/board/freescale/imx8mm_evk/imx8mm_evk.c
@@ -23,8 +23,8 @@ DECLARE_GLOBAL_DATA_PTR;
 #define WDOG_PAD_CTRL	(PAD_CTL_DSE6 | PAD_CTL_ODE | PAD_CTL_PUE | PAD_CTL_PE)
 
 static iomux_v3_cfg_t const uart_pads[] = {
-	IMX8MM_PAD_UART2_RXD_UART2_RX | MUX_PAD_CTRL(UART_PAD_CTRL),
-	IMX8MM_PAD_UART2_TXD_UART2_TX | MUX_PAD_CTRL(UART_PAD_CTRL),
+	IMX8MM_PAD_UART3_RXD_UART3_RX | MUX_PAD_CTRL(UART_PAD_CTRL),
+	IMX8MM_PAD_UART3_TXD_UART3_TX | MUX_PAD_CTRL(UART_PAD_CTRL),
 };
 
 static iomux_v3_cfg_t const wdog_pads[] = {
@@ -75,7 +75,7 @@ int board_early_init_f(void)
 
 	imx_iomux_v3_setup_multiple_pads(uart_pads, ARRAY_SIZE(uart_pads));
 
-	init_uart_clk(1);
+	init_uart_clk(2);
 
 #ifdef CONFIG_NAND_MXS
 	setup_gpmi_nand(); /* SPL will call the board_early_init_f */
diff --git a/board/freescale/imx8mm_evk/spl.c b/board/freescale/imx8mm_evk/spl.c
index 3f65582ef4..b9ca6e8786 100644
--- a/board/freescale/imx8mm_evk/spl.c
+++ b/board/freescale/imx8mm_evk/spl.c
@@ -16,7 +16,7 @@
 #include <asm/arch/ddr.h>
 
 #include <power/pmic.h>
-#include <power/bd71837.h>
+#include <power/pca9450.h>
 #include <asm/mach-imx/gpio.h>
 #include <asm/mach-imx/mxc_i2c.h>
 #include <fsl_esdhc_imx.h>
@@ -179,42 +179,52 @@ int board_mmc_getcd(struct mmc *mmc)
 	return 1;
 }
 
-#ifdef CONFIG_POWER
-#define I2C_PMIC	0
+ #ifdef CONFIG_POWER
+ #define I2C_PMIC        0
 int power_init_board(void)
 {
 	struct pmic *p;
 	int ret;
 
-	ret = power_bd71837_init(I2C_PMIC);
+	ret = power_pca9450a_init(I2C_PMIC);
 	if (ret)
 		printf("power init failed");
 
-	p = pmic_get("BD71837");
+	p = pmic_get("PCA9450A");
 	pmic_probe(p);
 
+	/* BUCKxOUT_DVS0/1 control BUCK123 output */
+	pmic_reg_write(p, PCA9450_BUCK123_DVS, 0x29);
 
-	/* decrease RESET key long push time from the default 10s to 10ms */
-	pmic_reg_write(p, BD71837_PWRONCONFIG1, 0x0);
+	/* Buck 1 DVS control through PMIC_STBY_REQ */
+	pmic_reg_write(p, PCA9450_BUCK1CTRL, 0x59);
 
-	/* unlock the PMIC regs */
-	pmic_reg_write(p, BD71837_REGLOCK, 0x1);
+	/* decrease RESET key long push time from the default 10s to 10ms */
+	/* Ton_Deb of PCA9450 is 20ms and don't change */
 
 	/* increase VDD_SOC to typical value 0.85v before first DRAM access */
-	pmic_reg_write(p, BD71837_BUCK1_VOLT_RUN, 0x0f);
+	/* pmic_reg_write(p, PCA9450_BUCK1OUT_DVS0, 0x14); */
+	pmic_reg_write(p, PCA9450_BUCK1OUT_DVS0, 0x14);
+	pmic_reg_write(p, PCA9450_BUCK1OUT_DVS1, 0x10);
 
-	/* increase VDD_DRAM to 0.975v for 3Ghz DDR */
-	pmic_reg_write(p, BD71837_BUCK5_VOLT, 0x83);
+	/* increase VDD_DRAM to 0.975v for 3Ghz DDR -> 0.95V instead of 0.975V, */
+	/* because PCA9450 Buck3 can set 0.95V */
+	/* Also, set B3_ENMODE=2 (ON by PMIC_ON_REQ=H & PMIC_STBY_REQ=L) */
+	pmic_reg_write(p, PCA9450_BUCK3OUT_DVS0, 0x1C);
+	pmic_reg_write(p, PCA9450_BUCK3CTRL, 0x4A);
+
+	/* set VDD_SNVS_0V8 from default 0.85V */
+	pmic_reg_write(p, PCA9450_LDO2CTRL, 0xC0);
 
 #ifndef CONFIG_IMX8M_LPDDR4
-	/* increase NVCC_DRAM_1V2 to 1.2v for DDR4 */
-	pmic_reg_write(p, BD71837_BUCK8_VOLT, 0x28);
+        /* increase NVCC_DRAM_1V2 to 1.2v for DDR4 */
+        pmic_reg_write(p, PCA9450_BUCK6OUT, 0x18);
 #endif
 
-	/* lock the PMIC regs */
-	pmic_reg_write(p, BD71837_REGLOCK, 0x11);
+        /* set WDOG_B_CFG to 10b=Cold Reset, except LDO1/2 */
+        pmic_reg_write(p, PCA9450_RESET_CTRL, 0xA1);
 
-	return 0;
+        return 0;
 }
 #endif
 
diff --git a/include/configs/imx8mm_evk.h b/include/configs/imx8mm_evk.h
index 0f0c1b2f11..db07ebb544 100644
--- a/include/configs/imx8mm_evk.h
+++ b/include/configs/imx8mm_evk.h
@@ -33,7 +33,8 @@
 #define CONFIG_POWER
 #define CONFIG_POWER_I2C
 #define CONFIG_POWER_BD71837
-
+#undef CONFIG_POWER_BD71837
+#define CONFIG_POWER_PCA9450
 #define CONFIG_SYS_I2C
 
 #if defined(CONFIG_NAND_BOOT)
@@ -118,7 +119,7 @@
 	"script=boot.scr\0" \
 	"image=Image\0" \
 	"splashimage=0x50000000\0" \
-	"console=ttymxc1,115200\0" \
+	"console=ttymxc2,115200\0" \
 	"fdt_addr=0x43000000\0"			\
 	"fdt_high=0xffffffffffffffff\0"		\
 	"boot_fit=no\0" \
@@ -212,7 +213,8 @@
 #define CONFIG_SYS_MEMTEST_START	PHYS_SDRAM
 #define CONFIG_SYS_MEMTEST_END		(CONFIG_SYS_MEMTEST_START + (PHYS_SDRAM_SIZE >> 1))
 
-#define CONFIG_MXC_UART_BASE		UART2_BASE_ADDR
+#define CONFIG_MXC_UART
+#define CONFIG_MXC_UART_BASE		UART3_BASE_ADDR
 
 /* Monitor Command Prompt */
 #define CONFIG_SYS_PROMPT_HUSH_PS2	"> "
-- 
2.30.2

